<div class="container py-4">
  <div class="mx-auto" style="max-width: 400px;">
    
    <!-- Test Already Completed Message -->
    <div *ngIf="testAlreadyCompleted" class="text-center">
      <div class="card border-success">
        <div class="card-body">
          <div class="mb-3">
            <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
          </div>
          <h4 class="card-title text-success">Test Already Completed!</h4>
          <p class="card-text text-muted">
            You have already completed the questionnaire. If you want to retake it, click the button below.
          </p>
          <div class="d-flex gap-2 justify-content-center">
            <button class="btn btn-primary" (click)="goHome()">
              <i class="bi bi-house"></i> Go Home
            </button>
            <button class="btn btn-warning" (click)="retakeTest()">
              <i class="bi bi-arrow-clockwise"></i> Retake Test
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Regular Questionnaire -->
    <div *ngIf="!testAlreadyCompleted">
      <div class="mb-3">
      <div class="progress" style="height: 0.5rem;">
        <div
          class="progress-bar bg-info"
          role="progressbar"
          [style.width.%]="((currentStep + 1) / questions.length) * 100"
          [attr.aria-valuenow]="((currentStep + 1) / questions.length) * 100"
          aria-valuemin="0"
          aria-valuemax="100"
        >
        </div>
      </div>
    </div>

    <div *ngIf="currentQuestion" class="mt-4">
      <div class="fw-bold fs-4 text-center mb-4" [innerHTML]="formatQuestionText(currentQuestion?.questionText || '')"></div>

      <!-- SINGLE_CHOICE -->
      <div *ngIf="currentQuestion.questionType === 'SINGLE_CHOICE'">
        <div class="d-flex flex-column align-items-center gap-3">
          <button
            *ngFor="let opt of currentQuestion.options"
            class="btn btn-warning btn-lg w-100"
            [class.active]="answers[currentQuestion.id] === opt.value"
            (click)="selectSingleChoice(currentQuestion.id, opt.value)">
            {{ opt.optionText }}
          </button>
        </div>
      </div>

      <!-- MULTIPLE_CHOICE -->
      <div *ngIf="currentQuestion.questionType === 'MULTIPLE_CHOICE'">
        <div class="d-flex flex-column align-items-center gap-3">
          <button
            *ngFor="let opt of currentQuestion.options"
            class="btn btn-warning btn-lg w-100"
            [class.active]="(answers[currentQuestion.id] || []).includes(opt.value)"
            (click)="selectMultiChoice(currentQuestion.id, opt.value)">
            {{ opt.optionText }}
          </button>
        </div>
      </div>

      <!-- TEXT_INPUT -->
      <div *ngIf="currentQuestion.questionType === 'TEXT_INPUT'">
        <input type="text" class="form-control form-control-lg" [(ngModel)]="answers[currentQuestion.id]" placeholder="Type your answer..." />
      </div>

      <!-- NUMBER_INPUT -->
      <div *ngIf="currentQuestion.questionType === 'NUMBER_INPUT'">
        <input type="number" class="form-control form-control-lg" [(ngModel)]="answers[currentQuestion.id]" placeholder="Enter a number..." />
      </div>

      <!-- DATE_INPUT -->
      <div *ngIf="currentQuestion.questionType === 'DATE_INPUT'">
        <input type="date" class="form-control form-control-lg" [(ngModel)]="answers[currentQuestion.id]" />
      </div>

      <!-- AUTOCOMPLETE_INPUT -->
      <div *ngIf="currentQuestion.questionType === 'AUTOCOMPLETE_INPUT'">
        <input type="text" class="form-control form-control-lg" [(ngModel)]="answers[currentQuestion.id]" placeholder="Start typing..." list="autocompleteOptions" />
        <datalist id="autocompleteOptions">
          <option *ngFor="let opt of currentQuestion.options" [value]="opt.optionText"></option>
        </datalist>
      </div>
    </div>

    <div class="d-flex justify-content-between mt-5">
      <button class="btn btn-danger" (click)="prev()" [disabled]="currentStep === 0">
        <i class="bi bi-arrow-left"></i> Previous
      </button>
      <button *ngIf="!isLastStep()" class="btn btn-primary px-4" (click)="next()" [disabled]="!currentQuestion || !isAnswered(currentQuestion)">
        Next <i class="bi bi-arrow-right"></i>
      </button>
      <button *ngIf="isLastStep()" class="btn btn-success px-4" (click)="submit()" [disabled]="!currentQuestion || !isAnswered(currentQuestion) || isSubmitting">
        <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        {{ isSubmitting ? 'Submitting...' : 'Submit' }}
      </button>
    </div>
    </div> <!-- End Regular Questionnaire -->
  </div>
</div>
